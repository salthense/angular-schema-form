!function(e,t){"function"==typeof define&&define.amd?define(["angular","objectpath","tv4"],t):"object"==typeof exports?module.exports=t(require("angular"),require("objectpath"),require("tv4")):e.schemaForm=t(e.angular,e.objectpath,e.tv4)}(this,function(e,t,r){var n=[];try{e.module("ngSanitize"),n.push("ngSanitize")}catch(o){}try{e.module("ui.sortable"),n.push("ui.sortable")}catch(o){}try{e.module("angularSpectrumColorpicker"),n.push("angularSpectrumColorpicker")}catch(o){}var i=e.module("schemaForm",n);return e.module("schemaForm").provider("sfPath",[function(){var r=window.ObjectPath||t,n={parse:r.parse};1===e.version.major&&e.version.minor<3?n.stringify=function(e){return Array.isArray(e)?e.join("."):e.toString()}:n.stringify=r.stringify,n.normalize=function(e,t){return n.stringify(Array.isArray(e)?e:n.parse(e),t)},this.parse=n.parse,this.stringify=n.stringify,this.normalize=n.normalize,this.$get=function(){return n}}]),e.module("schemaForm").factory("sfSelect",["sfPath",function(e){var t=/^\d+$/;return function(r,n,o){n||(n=this);var i="string"==typeof r?e.parse(r):r;if("undefined"!=typeof o&&1===i.length)return n[i[0]]=o,n;"undefined"!=typeof o&&"undefined"==typeof n[i[0]]&&(n[i[0]]=i.length>2&&t.test(i[1])?[]:{});for(var a=n[i[0]],l=1;l<i.length;l++){if(""===i[l])return void 0;if("undefined"!=typeof o){if(l===i.length-1)return a[i[l]]=o,o;var s=a[i[l]];("undefined"==typeof s||null===s)&&(s=t.test(i[l+1])?[]:{},a[i[l]]=s),a=s}else a&&(a=a[i[l]])}return a}}]),e.module("schemaForm").provider("sfBuilder",["sfPathProvider",function(t){var r=/[A-Z]/g,n=function(e,t){return t=t||"_",e.replace(r,function(e,r){return(r?t:"")+e.toLowerCase()})},o=0,i={sfField:function(e){e.fieldFrag.firstChild.setAttribute("sf-field",o),e.lookup["f"+o]=e.form,o++},ngModel:function(e){if(e.form.key){var r=e.form.key;e.state.keyRedaction&&(r=r.slice(e.state.keyRedaction));var n;if(e.state.modelValue)n=e.state.modelValue;else{var o=t.stringify(r).replace(/"/g,"&quot;");n=e.state.modelName||"model",o&&(n+=("["!==o[0]?".":"")+o)}for(var i=e.fieldFrag.querySelectorAll("[sf-field-model]"),a=0;a<i.length;a++){var l=i[a],s=l.getAttribute("sf-field-model");if(s&&""!==s)if("replaceAll"===s)for(var u=l.attributes,c=0;c<u.length;c++)u[c].value&&-1!==u[c].value.indexOf("$$value")&&(u[c].value=u[c].value.replace(/\$\$value\$\$/g,n));else{var f=l.getAttribute(s);f&&f.indexOf("$$value$$")?l.setAttribute(s,f.replace(/\$\$value\$\$/g,n)):l.setAttribute(s,n)}else l.setAttribute("ng-model",n)}}},simpleTransclusion:function(e){var t=e.build(e.form.items,e.path+".items",e.state);e.fieldFrag.firstChild.appendChild(t)},ngModelOptions:function(e){e.form.ngModelOptions&&Object.keys(e.form.ngModelOptions).length>0&&e.fieldFrag.firstChild.setAttribute("ng-model-options",JSON.stringify(e.form.ngModelOptions))},transclusion:function(e){var t=e.fieldFrag.querySelectorAll("[sf-field-transclude]");if(t.length)for(var r=0;r<t.length;r++){var n=t[r],o=n.getAttribute("sf-field-transclude")||"items",i=e.form[o];if(i){var a=e.build(i,e.path+"."+o,e.state);n.appendChild(a)}}},condition:function(e){if(e.form.condition){var r="evalExpr("+e.path+'.condition, { model: model, "arrayIndex": $index})';if(e.form.key){var n=t.stringify(e.form.key);r="evalExpr("+e.path+'.condition,{ model: model, "arrayIndex": $index, "modelValue": model'+("["===n[0]?"":".")+n+"})"}for(var o=e.fieldFrag.children||e.fieldFrag.childNodes,i=0;i<o.length;i++){var a=o[i],l=a.getAttribute("ng-if");a.setAttribute("ng-if",l?"("+l+") || ("+r+")":r)}}},array:function(r){var n=r.fieldFrag.querySelector("[schema-form-array-items]");if(n){if(state=e.copy(r.state),state.keyRedaction=0,state.keyRedaction+=r.form.key.length+1,r.form.schema&&r.form.schema.items&&r.form.schema.items.type&&-1===r.form.schema.items.type.indexOf("object")&&-1===r.form.schema.items.type.indexOf("array")){t.stringify(r.form.key).replace(/"/g,"&quot;")+"[$index]";state.modelValue="modelArray[$index]"}else state.modelName="item";state.arrayCompatFlag=!0;var o=r.build(r.form.items,r.path+".items",state);n.appendChild(o)}},typeahead:function(e){if(e.form.typeahead){var t=e.fieldFrag.querySelector("input");t?(t.setAttribute("uib-typeahead","value for value in options.typeahead(schema, form, $viewValue)"),t.setAttribute("typeahead-min-length","0")):console.warn("could not find input field for typeahead",e.form)}},userTypeahead:function(e){if(e.form.userTypeahead){var t=e.fieldFrag.querySelector("input");t?(t.setAttribute("uib-typeahead","value for value in options.userTypeahead($viewValue, form.group, form.fields)"),t.setAttribute("typeahead-min-length","0")):console.warn("could not find input field for typeahead",e.form)}},link:function(e){if(e.form.link){var t=e.fieldFrag.querySelector("input");t?(t.setAttribute("uib-typeahead","value for value in options.relationTypeahead($viewValue, form.schema.relation, form.schema.link, form.schema.filters)"),t.setAttribute("typeahead-min-length","0"),t.setAttribute("typeahead-on-select","setLink($item, $model, $label, $event, $index)"),t.setAttribute("typeahead-template-url","types/"+e.form.schema.relation+"/typeaheadRepresentation.html")):console.warn("could not find input field for typeahead",e.form)}},measurement:function(e){setTimeout(function(){$("#measurementModal"+e.form.key.join("")).on("shown.bs.modal",function(){$("#measurementContainer"+e.form.key.join("")+" input").first().focus()}).on("keyup",function(t){if(13==t.keyCode){var r=$(document.activeElement),n=$("#measurementContainer"+e.form.key.join("")+" input"),o=n.index(r)+1;o<n.length?n[o].focus():$("#measurementModal"+e.form.key.join("")).modal("hide")}})})},addon:function(e){if(e.form.addon){var t=e.fieldFrag.querySelector("input");if(!t)return;var r=document.createElement("div"),n=document.createElement("div");r.setAttribute("class","input-group"),n.setAttribute("class","input-group-addon"),t.parentElement.insertBefore(r,t),r.appendChild(t),e.form.addon.before?(n.innerHTML=e.form.addon.before,t.parentElement.insertBefore(n,t)):e.form.addon.after&&(n.innerHTML=e.form.addon.after,t.parentElement.insertBefore(n,t.nextSibling))}},attributes:function(e){e.form.attributes&&e.form.attributes.forEach(function(t){e.fieldFrag.querySelector("input").setAttribute(t.attribute,t.value)})}};this.builders=i;var a=[i.sfField,i.ngModel,i.ngModelOptions,i.condition];this.stdBuilders=a,this.$get=["$templateCache","schemaFormDecorators","sfPath",function(e,t,r){var o=function(e,t){if(e.key){var n=t[r.stringify(e.key)];if(n){for(;n.firstChild;)n.removeChild(n.firstChild);return n}}},l=function(e,t,r,i,a,s,u){s=s||{},u=u||Object.create(null),a=a||"schemaForm.form";var c=document.createDocumentFragment();return e.reduce(function(e,c,f){if(!c.type)return e;var m=t[c.type]||t["default"];if(m.replace){var d;s.arrayCompatFlag=!1;var p=document.createElement("div"),h=r(c,m)||r(c,t["default"]);for(p.innerHTML=h,d=document.createDocumentFragment();p.childNodes.length>0;)d.appendChild(p.childNodes[0]);var v={fieldFrag:d,form:c,lookup:u,state:s,path:a+"["+f+"]",build:function(e,n,o){return l(e,t,r,i,n,o,u)}},y=c.builder||m.builder;"function"==typeof y?y(v):y.forEach(function(e){e(v)}),(o(c,i)||e).appendChild(d)}else{var g=document.createElement(n(t.__name,"-"));s.arrayCompatFlag?g.setAttribute("form","copyWithIndex($index)"):g.setAttribute("form",a+"["+f+"]"),(o(c,i)||e).appendChild(g)}return e},c),c};return{build:function(t,r,n,o){return l(t,r,function(t,r){return"template"===t.type?t.template:e.get(r.template)},n,void 0,void 0,o)},builder:i,stdBuilders:a,internalBuild:l}}]}]),e.module("schemaForm").provider("schemaFormDecorators",["$compileProvider","sfPathProvider",function(t,r){var n="",o={},i=function(e,t){"sfDecorator"===e&&(e=n);var r=o[e];return r[t.type]?r[t.type].template:r["default"].template},a=function(n){t.directive(n,["$parse","$compile","$http","$templateCache","$interpolate","$q","sfErrorMessage","sfPath","sfSelect",function(t,o,a,l,s,u,c,f,m){return{restrict:"AE",replace:!1,transclude:!1,scope:!0,require:"?^sfSchema",link:function(t,d,p,h){t.$on("schemaFormPropagateNgModelController",function(e,r){e.stopPropagation(),e.preventDefault(),t.ngModel=r}),t.showTitle=function(){return t.form&&t.form.notitle!==!0&&t.form.title},t.listToCheckboxValues=function(t){var r={};return e.forEach(t,function(e){r[e]=!0}),r},t.checkboxValuesToList=function(t){var r=[];return e.forEach(t,function(e,t){e&&r.push(t)}),r},t.buttonClick=function(r,n){e.isFunction(n.onClick)?n.onClick(r,n):e.isString(n.onClick)&&(h?h.evalInParentScope(n.onClick,{$event:r,form:n}):t.$eval(n.onClick,{$event:r,form:n}))},t.evalExpr=function(e,r){return h?h.evalInParentScope(e,r):t.$eval(e,r)},t.evalInScope=function(e,r){return e?t.$eval(e,r):void 0},t.interp=function(e,t){return e&&s(e)(t)},t.hasSuccess=function(){return t.ngModel?t.ngModel.$valid&&(!t.ngModel.$pristine||!t.ngModel.$isEmpty(t.ngModel.$modelValue)):!1},t.hasError=function(){return t.ngModel?t.ngModel.$invalid&&!t.ngModel.$pristine:!1},t.errorMessage=function(e){return c.interpolate(e&&e.code+""||"default",t.ngModel&&t.ngModel.$modelValue||"",t.ngModel&&t.ngModel.$viewValue||"",t.form,t.options&&t.options.validationMessage)};var v=t.$watch(p.form,function(s){if(s){s.ngModelOptions=s.ngModelOptions||{},t.form=s;var c;if("template"===s.type&&s.template)c=u.when(s.template);else{var p="template"===s.type?s.templateUrl:i(n,s);c=a.get(p,{cache:l}).then(function(e){return e.data})}c.then(function(n){if(s.key){var i=e.copy(s.key).reverse(),a=[],l=t;try{a=i.map(function(e,t,r){if(""===e){for(var n=l.$index;!l.hasOwnProperty("$index");)l=l.$parent;return l=l.$parent,n}return e}).reverse()}catch(u){console.error("Wrong path in ngModel! Please check your form!")}var c=a?r.stringify(a).replace(/"/g,"&quot;"):"";n=n.replace(/\$\$value\$\$/g,"model"+("["!==c[0]?".":"")+c)}if(d.html(n),s.condition){var m='evalExpr(form.condition,{ model: model, "arrayIndex": arrayIndex})';s.key&&(m='evalExpr(form.condition,{ model: model, "arrayIndex": arrayIndex, "modelValue": model'+f.stringify(s.key)+"})"),e.forEach(d.children(),function(e){var t=e.getAttribute("ng-if");e.setAttribute("ng-if",t?"("+t+") || ("+m+")":m)})}o(d.contents())(t)}),s.key&&(t.$on("schemaForm.error."+s.key.join("."),function(e,r,n,o){(n===!0||n===!1)&&(o=n,n=void 0),t.ngModel&&r&&(t.ngModel.$setDirty?t.ngModel.$setDirty():(t.ngModel.$dirty=!0,t.ngModel.$pristine=!1),n&&(s.validationMessage||(s.validationMessage={}),s.validationMessage[r]=n),t.ngModel.$setValidity(r,o===!0),o===!0&&(t.ngModel.$validate(),t.$broadcast("schemaFormValidate")))}),t.$on("$destroy",function(){if(!t.externalDestructionInProgress){var e=s.destroyStrategy||t.options&&t.options.destroyStrategy||"remove";if(s.key&&"retain"!==e){var r=t.model;if(s.key.length>1&&(r=m(s.key.slice(0,s.key.length-1),r)),void 0===r)return;var n=s.schema&&s.schema.type||"";"empty"===e&&-1!==n.indexOf("string")?r[s.key.slice(-1)]="":"empty"===e&&-1!==n.indexOf("object")?r[s.key.slice(-1)]={}:"empty"===e&&-1!==n.indexOf("array")?r[s.key.slice(-1)]=[]:"null"===e?r[s.key.slice(-1)]=null:delete r[s.key.slice(-1)]}}})),v()}})}}}])},l=function(r,n,o){o=e.isDefined(o)?o:!1,t.directive("sf"+e.uppercase(r[0])+r.substr(1),function(){return{restrict:"EAC",scope:!0,replace:!0,transclude:o,template:'<sf-decorator form="form"></sf-decorator>',link:function(t,n,o){var i={items:"c",titleMap:"c",schema:"c"},a={type:r},l=!0;e.forEach(o,function(r,n){if("$"!==n[0]&&0!==n.indexOf("ng")&&"sfField"!==n){var s=function(r){e.isDefined(r)&&r!==a[n]&&(a[n]=r,l&&a.type&&(a.key||e.isUndefined(o.key))&&(t.form=a,l=!1))};"model"===n?t.$watch(r,function(e){e&&t.model!==e&&(t.model=e)}):"c"===i[n]?t.$watchCollection(r,s):o.$observe(n,s)}})}}})};this.createDecorator=function(t,r){o[t]={__name:t},e.forEach(r,function(e,r){o[t][r]={template:e,replace:!1,builder:[]}}),o[n]||(n=t),a(t)},this.defineDecorator=function(t,r){o[t]={__name:t},e.forEach(r,function(r,n){r.builder=r.builder||[],r.replace=e.isDefined(r.replace)?r.replace:!0,o[t][n]=r}),o[n]||(n=t),a(t)},this.createDirective=l,this.createDirectives=function(t){e.forEach(t,function(e,t){l(t,e)})},this.decorator=function(e){return e=e||n,o[e]},this.addMapping=function(e,t,r,n,i){o[e]&&(o[e][t]={template:r,builder:n,replace:!!i})},this.defineAddOn=function(e,t,r,n){o[e]&&(o[e][t]={template:r,builder:n,replace:!0})},this.$get=function(){return{decorator:function(e){return o[e]||o[n]},defaultDecorator:n}},a("sfDecorator")}]),e.module("schemaForm").provider("sfErrorMessage",function(){var t={"default":"Field does not validate",0:"Invalid type, expected {{schema.type}}",1:"No enum match for: {{viewValue}}",10:'Data does not match any schemas from "anyOf"',11:'Data does not match any schemas from "oneOf"',12:'Data is valid against more than one schema from "oneOf"',13:'Data matches schema from "not"',100:"Value is not a multiple of {{schema.multipleOf}}",101:"{{viewValue}} is less than the allowed minimum of {{schema.minimum}}",102:"{{viewValue}} is equal to the exclusive minimum {{schema.minimum}}",103:"{{viewValue}} is greater than the allowed maximum of {{schema.maximum}}",104:"{{viewValue}} is equal to the exclusive maximum {{schema.maximum}}",105:"Value is not a valid number",200:"String is too short ({{viewValue.length}} chars), minimum {{schema.minLength}}",201:"String is too long ({{viewValue.length}} chars), maximum {{schema.maxLength}}",202:"String does not match pattern: {{schema.pattern}}",300:"Too few properties defined, minimum {{schema.minProperties}}",301:"Too many properties defined, maximum {{schema.maxProperties}}",302:"Required",303:"Additional properties not allowed",304:"Dependency failed - key must exist",400:"Array is too short ({{value.length}}), minimum {{schema.minItems}}",401:"Array is too long ({{value.length}}), maximum {{schema.maxItems}}",402:"Array items are not unique",403:"Additional items not allowed",500:"Format validation failed",501:'Keyword failed: "{{title}}"',600:"Circular $refs",1e3:"Unknown property (not in schema)"};t.number=t[105],t.required=t[302],t.min=t[101],t.max=t[103],t.maxlength=t[201],t.minlength=t[200],t.pattern=t[202],this.setDefaultMessages=function(e){t=e},this.getDefaultMessages=function(){return t},this.setDefaultMessage=function(e,r){t[e]=r},this.$get=["$interpolate",function(r){var n={};return n.defaultMessages=t,n.interpolate=function(n,o,i,a,l){l=l||{};var s=a.validationMessage||{};0===n.indexOf("tv4-")&&(n=n.substring(4));var u=s["default"]||l["default"]||"";[s,l,t].some(function(t){return e.isString(t)||e.isFunction(t)?(u=t,!0):t&&t[n]?(u=t[n],!0):void 0});var c={error:n,value:o,viewValue:i,form:a,schema:a.schema,title:a.title||a.schema&&a.schema.title};return e.isFunction(u)?u(c):r(u)(c)},n}]}),e.module("schemaForm").provider("schemaForm",["sfPathProvider",function(t){var r=function(e){if(Array.isArray(e)&&2==e.length){if("null"===e[0])return e[1];if("null"===e[1])return e[0]}return e},n=function(e){var t=[];return e.forEach(function(e){t.push({name:e,value:e})}),t},o=function(t,r){if(!e.isArray(t)){var n=[];return r?e.forEach(r,function(e,r){n.push({name:t[e],value:e})}):e.forEach(t,function(e,t){n.push({name:e,value:t})}),n}return t},i=function(t,n,o){var i=h[r(n.type)];if(i)for(var a,l=0;l<i.length;l++)if(a=i[l](t,n,o))return a.schema["x-schema-form"]&&e.isObject(a.schema["x-schema-form"])&&(a=e.extend(a,a.schema["x-schema-form"])),a},a=function(t,r,n){n=n||{};var i=n.global&&n.global.formDefaults?e.copy(n.global.formDefaults):{};return n.global&&n.global.supressPropertyTitles===!0?i.title=r.title:i.title=r.title||t,r.unit&&(i.addon||(i.addon={}),i.addon.after=r.unit),r.description&&(i.description=r.description),(n.required===!0||r.required===!0)&&(i.required=!0),r.maxLength&&(i.maxlength=r.maxLength),r.minLength&&(i.minlength=r.minLength),(r.readOnly||r.readonly)&&(i.readonly=!0),r.minimum&&(i.minimum=r.minimum+(r.exclusiveMinimum?1:0)),r.maximum&&(i.maximum=r.maximum-(r.exclusiveMaximum?1:0)),r.validationMessage&&(i.validationMessage=r.validationMessage),r.enumNames&&(i.titleMap=o(r.enumNames,r["enum"])),i.schema=r,i.ngModelOptions=i.ngModelOptions||{},i},l=function(e,n,o){if("string"===r(n.type)&&!n["enum"]){var i=a(e,n,o);return i.key=o.path,i.type="text",o.lookup[t.stringify(o.path)]=i,i}},s=function(e,n,o){if("number"===r(n.type)){var i=a(e,n,o);return i.key=o.path,i.type="number",o.lookup[t.stringify(o.path)]=i,i}},u=function(e,n,o){if("integer"===r(n.type)){var i=a(e,n,o);return i.key=o.path,i.type="number",o.lookup[t.stringify(o.path)]=i,i}},c=function(e,n,o){if("boolean"===r(n.type)){var i=a(e,n,o);return i.key=o.path,i.type="checkbox",o.lookup[t.stringify(o.path)]=i,i}},f=function(e,o,i){if("string"===r(o.type)&&o["enum"]){var l=a(e,o,i);return l.key=i.path,l.type="select",l.titleMap||(l.titleMap=n(o["enum"])),i.lookup[t.stringify(i.path)]=l,l}},m=function(e,o,i){if("array"===r(o.type)&&o.items&&o.items["enum"]){var l=a(e,o,i);return l.key=i.path,l.type="checkboxes",l.titleMap||(l.titleMap=n(o.items["enum"])),i.lookup[t.stringify(i.path)]=l,l}},d=function(n,o,l){if("object"===r(o.type)){var s=a(n,o,l);return s.type="fieldset",s.items=[],l.lookup[t.stringify(l.path)]=s,e.forEach(o.properties,function(e,r){var n=l.path.slice();if(n.push(r),l.ignore[t.stringify(n)]!==!0){var a=o.required&&-1!==o.required.indexOf(r),u=i(r,e,{path:n,required:a||!1,lookup:l.lookup,ignore:l.ignore,global:l.global});u&&s.items.push(u)}}),s}},p=function(e,n,o){if("array"===r(n.type)){var l=a(e,n,o);l.type="array",l.key=o.path,o.lookup[t.stringify(o.path)]=l;var s=n.required&&-1!==n.required.indexOf(o.path[o.path.length-1]),u=o.path.slice();return u.push(""),l.items=[i(e,n.items,{path:u,required:s||!1,lookup:o.lookup,ignore:o.ignore,global:o.global})],l}},h={string:[f,l],object:[d],number:[s],integer:[u],"boolean":[c],array:[m,p]},v=function(e){return e};this.defaults=h,this.stdFormObj=a,this.defaultFormDefinition=i,this.postProcess=function(e){v=e},this.appendRule=function(e,t){h[e]||(h[e]=[]),h[e].push(t)},this.prependRule=function(e,t){h[e]||(h[e]=[]),h[e].unshift(t)},this.createStandardForm=a,this.$get=function(){var n={};return n.merge=function(r,i,a,l,s,u){i=i||["*"],l=l||{},s=s||r.readonly||r.readOnly;var c=n.defaults(r,a,l),f=i.indexOf("*");-1!==f&&(i=i.slice(0,f).concat(c.form).concat(i.slice(f+1)));var m=c.lookup;return v(i.map(function(i){if("string"==typeof i&&(i={key:i}),i.key&&"string"==typeof i.key&&(i.key=t.parse(i.key)),i.titleMap&&(i.titleMap=o(i.titleMap)),i.itemForm){i.items=[];var c=t.stringify(i.key),f=m[c];e.forEach(f.items,function(t){var r=e.copy(i.itemForm);r.key=t.key,i.items.push(r)})}if(i.key){var d=t.stringify(i.key);if(m[d]){var p=m[d];e.forEach(p,function(e,t){void 0===i[t]&&(i[t]=p[t])})}}return s===!0&&(i.readonly=!0),i.items&&(i.items=n.merge(r,i.items,a,l,i.readonly,u)),i.rows&&(i.rows=n.merge(r,i.rows,a,l,i.readonly,u)),i.cols&&(i.cols=n.merge(r,i.cols,a,l,i.readonly,u)),i.tabs&&e.forEach(i.tabs,function(e){e.items=n.merge(r,e.items,a,l,i.readonly,u)}),"checkbox"===i.type&&e.isUndefined(i.schema["default"])&&(i.schema["default"]=!1),u&&"template"===i.type&&!i.template&&i.templateUrl&&u.push(i),i}))},n.defaults=function(t,n,o){var a=[],l={};if(n=n||{},o=o||{},"object"!==r(t.type))throw new Error('Not implemented. Only type "object" allowed at root level of schema.');return e.forEach(t.properties,function(e,r){if(n[r]!==!0){var s=t.required&&-1!==t.required.indexOf(r),u=i(r,e,{path:[r],lookup:l,ignore:n,required:s,global:o});u&&a.push(u)}}),{form:a,lookup:l}},n.traverseSchema=function(t,r,n,o){o=e.isDefined(o)?o:!0,n=n||[];var i=function(t,r,n){if(r(t,n),e.forEach(t.properties,function(e,t){var o=n.slice();o.push(t),i(e,r,o)}),!o&&t.items){var a=n.slice();a.push(""),i(t.items,r,a)}};i(t,r,n||[])},n.traverseForm=function(t,r){r(t),e.forEach(t.items,function(e){n.traverseForm(e,r)}),t.tabs&&e.forEach(t.tabs,function(t){e.forEach(t.items,function(e){n.traverseForm(e,r)})})},n}}]),e.module("schemaForm").factory("sfValidator",[function(){var t={};return t.validate=function(t,n){if(!t)return{valid:!0};var o=t.schema;if(!o)return{valid:!0};""===n&&(n=void 0),"number"===t.type&&null===n&&(n=void 0);var i={type:"object",properties:{}},a=t.key[t.key.length-1];i.properties[a]=o,t.required&&(i.required=[a]);var l={};return e.isDefined(n)&&(l[a]=n),r.validateResult(l,i)},t}]),e.module("schemaForm").directive("sfArray",["sfSelect","schemaForm","sfValidator","sfPath",function(t,r,n,o){var i=function(e){return function(t){t.key&&(t.key[t.key.indexOf("")]=e)}};return{restrict:"A",scope:!0,require:"?ngModel",link:function(a,l,s,u){var c={};a.validateArray=e.noop,u&&a.$emit("schemaFormPropagateNgModelController",u);var f=a.$watch(s.sfArray,function(l){if(l){var s=t(l.key,a.model),m=o.normalize(l.key);if(a.$watch("model"+("["!==m[0]?".":"")+m,function(e){s=a.modelArray=e}),e.isUndefined(s)&&(s=[],t(l.key,a.model,s)),a.modelArray=s,l.items){var d=l.items[0];l.items.length>1&&(d={type:"section",items:l.items.map(function(t){return t.ngModelOptions=l.ngModelOptions,e.isUndefined(t.readonly)&&(t.readonly=l.readonly),t})})}if(a.copyWithIndex=function(t){if(!c[t]&&d){var n=e.copy(d);n.arrayIndex=t,r.traverseForm(n,i(t)),c[t]=n}return c[t]},a.appendToArray=function(){var n=s.length,o=a.copyWithIndex(n);if(r.traverseForm(o,function(r){if(r.key){var n;e.isDefined(r["default"])&&(n=r["default"]),e.isDefined(r.schema)&&e.isDefined(r.schema["default"])&&(n=r.schema["default"]),e.isDefined(n)&&t(r.key,a.model,n)}}),n===s.length){var i,u=t("schema.items.type",l);"object"===u?i={}:"array"===u&&(i=[]),s.push(i)}return a.validateArray(),s},a.deleteFromArray=function(e){return s.splice(e,1),a.validateArray(),u&&u.$setDirty&&u.$setDirty(),s},l.titleMap||l.startEmpty===!0||0!==s.length||a.appendToArray(),l.titleMap&&l.titleMap.length>0){a.titleMapValues=[];var p=function(e){a.titleMapValues=[],e=e||[],l.titleMap.forEach(function(t){a.titleMapValues.push(-1!==e.indexOf(t.value))})};p(a.modelArray),a.$watchCollection("modelArray",p),a.$watchCollection("titleMapValues",function(e,t){if(e&&e!==t){for(var r=a.modelArray;r.length>0;)r.pop();l.titleMap.forEach(function(t,n){e[n]&&r.push(t.value)}),a.validateArray()}})}if(u){var h;a.validateArray=function(){var e=n.validate(l,a.modelArray.length>0?a.modelArray:void 0);Object.keys(u.$error).filter(function(e){return 0===e.indexOf("tv4-")}).forEach(function(e){u.$setValidity(e,!0)}),e.valid!==!1||!e.error||""!==e.error.dataPath&&e.error.dataPath!=="/"+l.key[l.key.length-1]||(u.$setViewValue(a.modelArray),h=e.error,u.$setValidity("tv4-"+e.error.code,!1))},a.$on("schemaFormValidate",a.validateArray),a.hasSuccess=function(){return a.options&&a.options.pristine&&a.options.pristine.success===!1?u.$valid&&!u.$pristine&&!u.$isEmpty(u.$modelValue):u.$valid&&(!u.$pristine||!u.$isEmpty(u.$modelValue))},a.hasError=function(){return a.options&&a.options.pristine&&a.options.pristine.errors===!1?u.$invalid&&!u.$warning&&!u.$pristine:u.$invalid&&!u.$warning},a.hasWarning=function(){return a.options&&a.options.pristine&&a.options.pristine.errors===!1?u.$warning&&!u.$pristine:u.$warning},a.schemaError=function(){return h}}f()}})}}}]),e.module("schemaForm").directive("sfChanged",function(){return{require:"ngModel",restrict:"AC",scope:!1,link:function(t,r,n,o){var i=t.$eval(n.sfChanged);i&&i.onChange&&o.$viewChangeListeners.push(function(){e.isFunction(i.onChange)?i.onChange(o.$modelValue,i):t.evalExpr(i.onChange,{modelValue:o.$modelValue,form:i})})}}}),e.module("schemaForm").directive("sfExmodule",["$rootScope","sfSelect","sfPath","schemaForm",function(e,t,r,n){return{require:"^sfSchema",scope:!1,link:{pre:function(e,t,r,n){e.form=n.lookup["f"+r.sfField]},post:function(e,t,r,n){e.clickEvent=function(){window.moduleFunctions[e.form.exmoduleOptions.moduleName].click(e)}}}}}]),e.module("schemaForm").directive("sfField",["$parse","$compile","$http","$templateCache","$interpolate","$q","sfErrorMessage","sfPath","sfSelect",function(t,r,n,o,i,a,l,s,u){return{restrict:"AE",replace:!1,transclude:!1,scope:!0,require:"^sfSchema",link:{pre:function(e,t,r,n){e.$on("schemaFormPropagateNgModelController",function(t,r){t.stopPropagation(),t.preventDefault(),e.ngModel=r}),e.form=n.lookup["f"+r.sfField]},post:function(t,r,n,o){t.showTitle=function(){return t.form&&t.form.notitle!==!0&&t.form.title},t.listToCheckboxValues=function(t){var r={};return e.forEach(t,function(e){r[e]=!0}),r},t.checkboxValuesToList=function(t){var r=[];return e.forEach(t,function(e,t){e&&r.push(t)}),r},t.buttonClick=function(r,n){e.isFunction(n.onClick)?n.onClick(r,n):e.isString(n.onClick)&&(o?o.evalInParentScope(n.onClick,{$event:r,form:n}):t.$eval(n.onClick,{$event:r,form:n}))},t.evalExpr=function(e,r){return o?o.evalInParentScope(e,r):t.$eval(e,r)},t.evalInScope=function(e,r){return e?t.$eval(e,r):void 0},t.interp=function(e,t){return e&&i(e)(t)},t.hasSuccess=function(){return t.ngModel?t.options&&t.options.pristine&&t.options.pristine.success===!1?t.ngModel.$valid&&!t.ngModel.$pristine&&!t.ngModel.$isEmpty(t.ngModel.$modelValue):t.ngModel.$valid&&(!t.ngModel.$pristine||!t.ngModel.$isEmpty(t.ngModel.$modelValue)):!1},t.hasError=function(){return t.ngModel?t.options&&t.options.pristine&&t.options.pristine.errors===!1?t.ngModel.$invalid&&!t.ngModel.$warning&&!t.ngModel.$pristine:t.ngModel.$invalid&&!t.ngModel.$warning:!1},t.hasWarning=function(){return t.ngModel?t.options&&t.options.pristine&&t.options.pristine.errors===!1?t.ngModel.$warning&&!t.ngModel.$pristine:t.ngModel.$warning:!1},t.errorMessage=function(e){return l.interpolate(e&&e.code+""||"default",t.ngModel&&t.ngModel.$modelValue||"",t.ngModel&&t.ngModel.$viewValue||"",t.form,t.options&&t.options.validationMessage)};var a=t.form;a.key&&(t.$on("schemaForm.error."+a.key.join("."),function(e,r,n,o){(n===!0||n===!1)&&(o=n,n=void 0),t.ngModel&&r&&(t.ngModel.$setDirty?t.ngModel.$setDirty():(t.ngModel.$dirty=!0,t.ngModel.$pristine=!1),n&&(a.validationMessage||(a.validationMessage={}),a.validationMessage[r]=n),t.ngModel.$setValidity(r,o===!0),o===!0&&(t.ngModel.$validate(),t.$broadcast("schemaFormValidate")))}),t.$on("$destroy",function(){if(!t.externalDestructionInProgress){var e=a.destroyStrategy||t.options&&t.options.destroyStrategy||"remove";if(a.key&&"retain"!==e){var r=t.model;if(a.key.length>1&&(r=u(a.key.slice(0,a.key.length-1),r)),void 0===r)return;var n=a.schema&&a.schema.type||"";"empty"===e&&-1!==n.indexOf("string")?r[a.key.slice(-1)]="":"empty"===e&&-1!==n.indexOf("object")?r[a.key.slice(-1)]={}:"empty"===e&&-1!==n.indexOf("array")?r[a.key.slice(-1)]=[]:"null"===e?r[a.key.slice(-1)]=null:delete r[a.key.slice(-1)]}}}))}}}}]),e.module("schemaForm").directive("sfLink",["$rootScope","sfSelect","sfPath","schemaForm",function(e,t,r,n){var o=function(e){return"model"+e.form.key.map(function(t){return t=""===t?e.$index:"'"+t+"'","["+t+"]"}).join("")};return{require:["^sfSchema","^ngModel"],options:"=sfOptions",scope:!1,link:{pre:function(e,t,r,n){e.form=n[0].lookup["f"+r.sfField],e.$evalAsync(function(){void 0!==e.evalInScope(o(e))&&(e.inputValue=e.evalInScope(o(e)).title,e.isValueSet=void 0!==e.inputValue)})},post:function(t,r,n,i){t.$watch(o(t),function(e,r){e!==r&&e&&(t.inputValue=e.title)},!0);var a=e.$on("modelUpdated",function(){try{t.inputValue=t.evalInScope(o(t)).title}catch(e){t.inputValue=null}});t.$on("$destroy",function(){a()}),t.change=function(){t.isValueSet=!1,""===t.inputValue&&t.evalInScope(o(t)+"=undefined")},t.setLink=function(r,n,a,l,s){i[1].$setDirty(),t.$item=r,t.evalInScope(o(t)+"=$item"),t.inputValue=r.title,t.isValueSet=!0,void 0!==t.inputValue&&e.$emit("setLink","model"+t.form.key.map(function(e){return""===e?"[]":"."+e}).join(""))}}}}}]),e.module("schemaForm").directive("sfLinkRepresentation",["$rootScope","sfSelect","sfPath","schemaForm",function(e,t,r,n){return{require:"^sfSchema",scope:!1,link:{post:function(t,r,n,o){var i=function(){return t.$eval("model."+t.form.representationSettings.watchFor+".id")},a=function(){var e=parseInt(t.$eval("model."+t.form.representationSettings.watchFor+".id"),10);t.depends(t.form.representationSettings.schema,e).then(function(e){t.representationDatas=e.data,t.representationDatas&&t.$evalAsync(function(){t.isSet=!0})})};t.recordTitle=t.form.representationSettings.schema,t.template=t.form.representationSettings.path;var l=e.$on("setLink",function(e,r){r==="model."+t.form.representationSettings.watchFor&&(t.isSet=!1,t.$evalAsync(function(){a()}))});void 0!==i()&&a(),r.on("$destroy",function(){l()})}}}}]),e.module("schemaForm").directive("sfMatrix",["$rootScope","sfSelect","sfPath","schemaForm",function(e,t,r,n){return{scope:!1,link:function(t,r,n){var o=new Proxy(t,{set:function(e,t,r){switch(t){case"matrixElements":e[t]=r,o.activeGroups=[],o.form.schema.items.properties.row["enum"].forEach(function(e){o.activeGroups.push(!1)}),o.setGroupState();break;case"matrixRows":e[t]=a(r);break;case"rowGroups":e[t]=s(r);break;default:e[t]=r}}}),i=e.$on("modelUpdated",function(){u();var e=n.sfMatrix.split("[").map(function(e){return e.replace("]","").split("'").join("")}),t=arguments[1];e.forEach(function(e){t=t[e]}),o.matrixElements=t});o.$on("$destroy",function(){i()});var a=function(e){var t=[];return e.forEach(function(e){Array.isArray(e)?t=t.concat(e):t.push(e)}),t},l=function(e,t){var r=null;return o.matrixElements.forEach(function(n){return n.row==e&&n.column==t?void(r=n):void 0}),r},s=function(e){var t=-1;return e.map(function(e,r){return{maxIndex:t+=e.length,group:r+1}})};o.isFirstInGroup=function(e){var t=o.getGroupForRow(e).group-1,r=o.rowGroups[t-1];return 0===e?!0:void 0!==r&&o.rowGroups[t-1].maxIndex===e-1?!0:!1},o.getGroupForRow=function(e){return o.rowGroups.find(function(t){return e<=t.maxIndex})},o.rowClass=function(e){return"matrix-group-"+o.getGroupForRow(e).group+(o.isFirstInGroup(e)?" matrix-group-first":"")},o.setGroupState=function(){o.activeGroups=o.activeGroups.map(function(){return!1}),o.matrixElements.forEach(function(e,t){var r=Math.floor(t/o.matrixColumns.length);e.selected&&(o.activeGroups[o.getGroupForRow(r).group-1]=!0)});var e=o.activeGroups.every(function(e){return e===!1});e&&(o.activeGroups=o.activeGroups.map(function(){return!0}))},o.rowGroups=o.form.schema.items.properties.row["enum"],o.matrixColumns=o.form.schema.items.properties.column["enum"],o.matrixRows=o.form.schema.items.properties.row["enum"],o.matrixMap={};var u=function(){o.matrixElements=o.$eval(n.sfMatrix)||[];var e=[],t=0;o.matrixRows.forEach(function(r){o.matrixMap[r]={},o.matrixColumns.forEach(function(n){o.matrixMap[r][n]=t,t++,e.push(l(r,n)||{column:n,row:r,selected:!1})})}),o.matrixElements.splice(0,o.matrixElements.length),e.forEach(function(e){o.matrixElements.push(e)}),o.$eval(n.sfMatrix+"= matrixElements")};u()}}}]),e.module("schemaForm").directive("measurements",["$compile",function(t){return{require:"^sfSchema",link:function(e,t,r,n){e.element=t},controller:["$scope",function(t){t.getLabel=function(e,t){var r=t+1;return!e||e.length<1?r:r+" ("+e[t%e.length]+")"},t.reset=function(e){for(var r in t.modelArray)delete t.modelArray[r].messwert;$("#measurementContainer"+e.key.join("")+" input")[0].focus()},t.$watch("modelArray",function(r,n){for(e.isUndefined(r)&&(t.modelArray=t.$eval($(t.element).first().attr("ng-model")+" = []"));t.modelArray.length<t.form.elementCount;)t.modelArray.push({});var o=function(){for(var e=0;e<t.modelArray.length;e++)try{null===t.modelArray[e].messwert&&delete t.modelArray[e]}catch(r){}};t.$evalAsync(o)})}]}}]),e.module("schemaForm").directive("sfMessage",["$injector","sfErrorMessage",function(t,r){var n=t.has("$sanitize")?t.get("$sanitize"):function(e){return e};return{scope:!1,restrict:"EA",link:function(t,o,i){var a="";i.sfMessage&&t.$watch(i.sfMessage,function(e){e&&(a=n(e),u(!!t.ngModel))});var l,s=function(e){e!==l&&(o.html(e),l=e)},u=function(n){if(n)if(t.hasError()){var o=[];e.forEach(t.ngModel&&t.ngModel.$error,function(e,t){e&&o.push(t)}),o=o.filter(function(e){return"schemaForm"!==e});var i=o[0];s(i?r.interpolate(i,t.ngModel.$modelValue,t.ngModel.$viewValue,t.form,t.options&&t.options.validationMessage):a);
}else s(a);else s(a)};u();var c=t.$watch("ngModel",function(e){e&&(e.$parsers.push(function(e){return u(!0),e}),e.$formatters.push(function(e){return u(!0),e}),c())});t.$watchCollection("ngModel.$error",function(){u(!!t.ngModel)})}}}]),e.module("schemaForm").directive("sfNewArray",["sfSelect","sfPath","schemaForm",function(t,r,n){return{scope:!1,link:function(o,i,a){o.min=0,o.modelArray=o.$eval(a.sfNewArray);var l=function(){o.modelArray=o.$eval(a.sfNewArray),(!(o.ngModel&&o.ngModel.$pristine&&o.firstDigest)||o.options&&o.options.validateOnRender===!0)&&o.validateField&&o.validateField()},s=function(){o.form&&o.form.onChange&&(e.isFunction(o.form.onChange)?o.form.onChange(o.modelArray,o.form):o.evalExpr(o.form.onChange,{modelValue:o.modelArray,form:o.form}))},u=function(){var e=o.modelArray;if(!e){var n=r.parse(a.sfNewArray);e=[],t(n,o,e),o.modelArray=e}return e},c=o.$watch("form",function(e){if(e){if(o.modelArray=o.$eval(a.sfNewArray),o.modelArray&&e.elementCount&&o.modelArray.length<e.elementCount)for(;o.modelArray.length<e.elementCount;)o.appendToArray();if(!(e.titleMap||e.startEmpty===!0||o.modelArray&&0!==o.modelArray.length)&&(o.appendToArray(),e.elementCount))for(var t=1;t<e.elementCount;t++)o.appendToArray();if(o.form&&o.form.schema&&o.form.schema.uniqueItems===!0?(o.$watch(a.sfNewArray,l,!0),o.$watch([a.sfNewArray,a.sfNewArray+".length"],s)):o.$watchGroup?o.$watchGroup([a.sfNewArray,a.sfNewArray+".length"],function(){l(),s()}):(o.$watch(a.sfNewArray,function(){l(),s()}),o.$watch(a.sfNewArray+".length",function(){l(),s()})),e.titleMap&&e.titleMap.length>0){o.titleMapValues=[];var r=function(t){o.titleMapValues=[],t=t||[],e.titleMap.forEach(function(e){o.titleMapValues.push(-1!==t.indexOf(e.value))})};r(o.modelArray),o.$watchCollection("modelArray",r),o.$watchCollection("titleMapValues",function(t,r){if(t&&t!==r){for(var n=u();n.length>0;)n.pop();e.titleMap.forEach(function(e,r){t[r]&&n.push(e.value)}),o.validateField&&o.validateField()}})}c()}});o.appendToArray=function(){var r,i=u();if(o.form&&o.form.schema&&o.form.schema.items){var a=o.form.schema.items;a.type&&-1!==a.type.indexOf("object")?(r={},o.options&&o.options.setSchemaDefaults===!1||(r=e.isDefined(a["default"])?a["default"]:r,r&&n.traverseSchema(a,function(n,o){e.isDefined(n["default"])&&t(o,r,n["default"])}))):a.type&&-1!==a.type.indexOf("array")?(r=[],o.options&&o.options.setSchemaDefaults===!1||(r=a["default"]||r)):o.options&&o.options.setSchemaDefaults===!1||(r=a["default"]||r)}return i.push(r),i},o.deleteFromArray=function(e){var t=o.modelArray;return t&&t.splice(e,1),t};var f=function(e){return function(t){t.key&&(t.key[t.key.indexOf("")]=e)}},m={};o.copyWithIndex=function(t){var r=o.form;if(!m[t]){var i=r.items[0];if(r.items.length>1&&(i={type:"section",items:r.items.map(function(t){return t.ngModelOptions=r.ngModelOptions,e.isUndefined(t.readonly)&&(t.readonly=r.readonly),t})}),i){var a=e.copy(i);a.arrayIndex=t,n.traverseForm(a,f(t)),m[t]=a}}return m[t]}}}}]),e.module("schemaForm").directive("sfRelation",["$rootScope","sfSelect","sfPath","schemaForm","$window","$location",function(t,r,n,o,i,a){return{require:"^sfSchema",link:{pre:function(e,t,r,n){e.form=n.lookup["f"+r.sfField],e.relations=[]},post:function(r,n,o){var l=function(){r.linking=r.depends(r.form.relationOptions.schema,r.form.relationOptions.path),r.linking.then(function(t){if(null!==t){r.records=t.records,r.recordTitle=r.form.relationOptions.schema;var n=r.form.relationOptions.path.split("/").map(function(e,t,r){return e.replace("[]","")}).filter(function(e,t,r){return""!==e}),o=function(t,r,n){if(n.length>1){var i=r[n.splice(0,1)[0]];Array.isArray(i)?i.forEach(function(r,i,a){o(t,r,e.copy(n))}):o(t,i,n)}else t.push(r[n[0]])};r.records.forEach(function(t,i){var a=[],l=[];o(a,t.data,e.copy(n)),a.forEach(function(e){l.push(r.depends(r.form.relationOptions.schema,e))}),Promise.all(l).then(function(e){e.length>0&&(void 0===r.linkedSchemaTitle&&r.depends(e[0].schema.id).then(function(e){r.linkedSchemaTitle=e}),r.relations[i]=e)})})}else r.relations=[],r.records=null})};l(),r.editRecord=function(e){var t="/schemas/";i.open(a.absUrl().slice(0,a.absUrl().indexOf(t)+t.length)+e.schema.id+"/edit/"+e.id,"_blank")};var s=t.$on("modelUpdated",function(){l()});r.$on("$destroy",function(){s()})}}}}]),formCache={},e.module("schemaForm").directive("sfSchema",["$compile","$http","$templateCache","$q","schemaForm","schemaFormDecorators","sfSelect","sfPath","sfBuilder",function(t,r,n,o,i,a,l,s,u){return{scope:{schema:"=sfSchema",initialForm:"=sfForm",model:"=sfModel",depends:"=sfDepends",options:"=sfOptions"},controller:["$scope",function(e){this.evalInParentScope=function(t,r){return e.$parent.$eval(t,r)};var t=this;e.lookup=function(e){return e&&(t.lookup=e),t.lookup}}],replace:!1,restrict:"A",transclude:!0,require:"?form",link:function(s,c,f,m,d){s.formCtrl=m;var p={};d(s,function(e){if(e.addClass("schema-form-ignore"),c.prepend(e),c[0].querySelectorAll){var t=c[0].querySelectorAll("[ng-model]");if(t)for(var r=0;r<t.length;r++){var n=t[r].getAttribute("ng-model");p[n.substring(n.indexOf(".")+1)]=!0}}});var h,v={},y=function(e,t){if("*"!=t[0]){var a,l=[],u=JSON.parse(localStorage.getItem("form-"+e.title)),c=localStorage.getItem("form-"+e.title+"-SchemaVersion")||0,f=localStorage.getItem("form-"+e.title+"-FormVersion")||0,m=function(e){return e>c?!0:!1},d=function(e){return s.options.getFormVersion(e)>f?!0:!1};s.options.getSchemaVersion().then(function(c){formCache[e.title]||(formCache[e.title]=u),(d(e.title)||m(c))&&(formCache[e.title]=i.merge(e,t,p,s.options,void 0,l),localStorage.setItem("form-"+e.title,JSON.stringify(formCache[e.title])),localStorage.setItem("form-"+e.title+"-SchemaVersion",c),localStorage.setItem("form-"+e.title+"-FormVersion",s.options.getFormVersion(e.title))),a=formCache[e.title],l.length>0?o.all(l.map(function(e){return r.get(e.templateUrl,{cache:n}).then(function(t){e.template=t.data})})).then(function(){g(e,t,a)}):g(e,t,a)})}},g=function(r,n,o){h&&(s.externalDestructionInProgress=!0,h.$destroy(),s.externalDestructionInProgress=!1),h=s.$new(),h.schemaForm={form:o,schema:r},c.children(":not(.schema-form-ignore)").remove();for(var m={},d=c[0].querySelectorAll("*[sf-insert-field]"),p=0;p<d.length;p++)m[d[p].getAttribute("sf-insert-field")]=d[p];var v=a.decorator(f.sfUseDecorator),y=Object.create(null);s.lookup(y),c[0].appendChild(u.build(o,v,m,y)),h.firstDigest=!0,setTimeout(function(){h.firstDigest=!1},0),t(c.children())(h),s.options&&s.options.setSchemaDefaults===!1||i.traverseSchema(r,function(t,r){if(e.isDefined(t["default"])){var n=l(r,s.model);e.isUndefined(n)&&l(r,s.model,t["default"])}}),s.$emit("sf-render-finished",c)},$=["*"];s.$watch(function(){var e=s.schema,t=s.initialForm||$;t&&e&&e.type&&(v.form!==t||v.schema!==e)&&Object.keys(e.properties).length>0&&(v.schema=e,v.form=t,y(e,t))}),s.$on("schemaFormRedraw",function(){var t=s.schema,r=s.initialForm?e.copy(s.initialForm):["*"];t&&y(t,r)}),s.$on("$destroy",function(){s.externalDestructionInProgress=!0}),s.evalExpr=function(e,t){return s.$parent.$eval(e,t)}}}}]),e.module("schemaForm").directive("schemaValidate",["sfValidator","$parse","sfSelect",function(t,r,n){return{restrict:"A",scope:!1,priority:500,require:"ngModel",link:function(r,o,i,a){r.$emit("schemaFormPropagateNgModelController",a);var l=null,s=r.$eval(i.schemaValidate);s.copyValueTo&&a.$viewChangeListeners.push(function(){var t=s.copyValueTo;e.forEach(t,function(e){n(e,r.model,a.$modelValue)})});var u=function(e){if(!s)return e;if(r.options&&r.options.tv4Validation===!1)return e;var n=t.validate(s,e);return Object.keys(a.$error).filter(function(e){return 0===e.indexOf("tv4-")}).forEach(function(e){a.$setValidity(e,!0)}),n.valid?e:(a.$setValidity("tv4-"+n.error.code,!1),l=n.error,a.$validators?e:void 0)};"function"==typeof s.ngModel&&s.ngModel(a),["$parsers","$viewChangeListeners","$formatters"].forEach(function(e){s[e]&&a[e]&&s[e].forEach(function(t){a[e].push(t)})}),["$validators","$asyncValidators"].forEach(function(t){s[t]&&a[t]&&e.forEach(s[t],function(e,r){a[t][r]=e})}),a.$parsers.push(u),a.$validators&&(a.$validators.schemaForm=function(){return!Object.keys(a.$error).some(function(e){return"schemaForm"!==e})});var c=s.schema;r.validateField=function(e){(void 0==e||a.$$parentForm.$name===e)&&(c&&-1!==c.type.indexOf("array")&&u(a.$modelValue),a.$setDirty?(a.$setDirty(),a.$setViewValue(a.$viewValue),a.$commitViewValue(),s.required&&a.$isEmpty(a.$modelValue)&&a.$setValidity("tv4-302",!1)):a.$setViewValue(a.$viewValue))},a.$formatters.push(function(e){return!a.$pristine||!r.firstDigest||r.options&&r.options.validateOnRender===!0?(u(a.$modelValue),e):e}),r.$on("schemaFormValidate",function(e,t){r.validateField(t)}),r.setState=function(e){var t=e.keys.filter(function(e){if(s.key.length!==e.length)return!1;for(var t=0;t<s.key.length;t++)if(s.key[t]!==e[t])return!1;return!0})[0];JSON.stringify(t)===JSON.stringify(s.key)&&(a.$warning="warning"===e.validationType,a.$setValidity("warningIncomplite",!a.$warning))},r.$on("schemaFormSetState",function(){r.setState(arguments[1])}),r.schemaError=function(){return l}}}}]),i});